# Audio Download Scripts

Download audio files from YouTube Music for analysis.

## Overview

This script downloads audio from YouTube Music using video IDs found in the previous step. It uses `yt-dlp` to download and convert audio to high-quality MP3 files (320kbps).

## Prerequisites

### 1. YouTube Account (REQUIRED)

**You must be signed in to YouTube in your browser** to download audio. YouTube now requires authentication to prevent bot abuse.

- Sign in to YouTube in Chrome (or Firefox/Safari/Edge)
- Keep your browser open while downloading
- The script will automatically extract cookies from your browser

### 2. Python Dependencies (Already Installed)

These are managed by Poetry and should already be installed:
- `yt-dlp` - YouTube downloader
- `loguru` - Logging

If needed, run:
```bash
poetry install
```

### 3. ffmpeg (System Dependency - REQUIRED)

ffmpeg is required by yt-dlp to convert audio to MP3 format.

**macOS:**
```bash
brew install ffmpeg
```

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install ffmpeg
```

**Windows:**
Download from https://ffmpeg.org/download.html or use:
```bash
choco install ffmpeg
```

**Verify Installation:**
```bash
ffmpeg -version
```

## Input File

The script reads from:
```
data/02_A_ytmusic_track_ids.txt
```

This file is generated by the YouTube Music ID search script:
```bash
poetry run python scripts/02_create/A_get_ids_for_ytmusic.py
```

Format:
```
Artist - Title  # ID: VIDEO_ID
```

## Output

Audio files are saved to:
```
data/03_downloaded_audio/
```

Filename format:
```
Artist - Title [VIDEO_ID].mp3
```

The `[VIDEO_ID]` suffix prevents duplicate downloads and allows resume capability.

## Usage

### Basic Usage

Download all tracks:
```bash
poetry run python scripts/03_download/download_audio_yt.py
```

### Test with Limited Downloads

Download only the first 10 tracks (for testing):
```bash
poetry run python scripts/03_download/download_audio_yt.py --max 10
```

### Force Re-download

Re-download files even if they already exist:
```bash
poetry run python scripts/03_download/download_audio_yt.py --force
```

### Specify Browser

Use cookies from a different browser (default: chrome):
```bash
# Firefox
poetry run python scripts/03_download/download_audio_yt.py --browser firefox

# Safari
poetry run python scripts/03_download/download_audio_yt.py --browser safari

# Edge
poetry run python scripts/03_download/download_audio_yt.py --browser edge
```

### Adjust Download Delay

Control the base delay for exponential backoff (default: 3 seconds):
```bash
# Faster base delay (2 seconds)
poetry run python scripts/03_download/download_audio_yt.py --delay 2

# Slower base delay (5 seconds - more polite to the service)
poetry run python scripts/03_download/download_audio_yt.py --delay 5

# No delay (not recommended)
poetry run python scripts/03_download/download_audio_yt.py --delay 0
```

**Exponential Backoff Behavior:**
- On success: Delay gradually decreases back to base delay (×0.9 per success)
- On failure: Delay doubles (up to 16× base delay)
- This automatically adapts to rate limiting and service availability

## Features

- **Resume Capability**: Automatically skips already-downloaded tracks by checking for files with matching video IDs
- **High Quality**: Downloads at 320kbps MP3 quality
- **Exponential Backoff**: Automatically adjusts delay based on success/failure (base delay: 3s)
  - Doubles delay on failures (up to 48s max)
  - Gradually reduces delay on successes
  - Adapts to rate limiting and service availability
- **Progress Tracking**: Shows download progress with success/failure counts
- **Timeout Protection**: 5-minute timeout per track to avoid hanging
- **Error Handling**: Continues downloading even if individual tracks fail

## How It Works

1. **Dependency Check**: Verifies yt-dlp and ffmpeg are installed
2. **Parse Input**: Reads video IDs from `02_A_ytmusic_track_ids.txt`
3. **Download Loop**: For each track:
   - Constructs YouTube Music URL: `https://music.youtube.com/watch?v={VIDEO_ID}`
   - Checks if already downloaded (by video ID)
   - Downloads audio using yt-dlp
   - Converts to MP3 using ffmpeg
   - Saves with formatted filename
4. **Summary**: Reports success/failure statistics

## Troubleshooting

### "ffmpeg not found"

**Problem**: ffmpeg is not installed or not in PATH

**Solution**:
```bash
# macOS
brew install ffmpeg

# Verify
ffmpeg -version
```

### "yt-dlp not found"

**Problem**: Python dependencies not installed

**Solution**:
```bash
poetry install
```

### Download Failures

**Problem**: Individual tracks fail to download

**Possible Causes**:
- Video is unavailable/deleted
- Network issues
- Age-restricted content
- Geographic restrictions

**Solution**: Check failed tracks in the output log. The script will continue with remaining tracks.

### Slow Downloads

**Problem**: Downloads taking too long

**Solution**:
- Check your internet connection
- Use `--max N` to test with fewer tracks first
- Consider running overnight for large collections

## Performance

- **Speed**: Depends on internet connection (typically 1-2 tracks/minute)
- **Storage**: ~5-10MB per track at 320kbps
- **Example**: 1,744 tracks ≈ 9-17GB storage, ~15-30 hours download time

## Next Steps

After downloading, proceed to:
```
scripts/04_analyze/
```

For audio feature extraction and analysis.

## Notes

- **Legal**: Only download content you have rights to or for personal/educational use
- **YouTube Music vs YouTube**: The script uses YouTube Music URLs which provide better audio quality for music
- **Duplicates**: The `[VIDEO_ID]` suffix prevents duplicate downloads if the same track appears multiple times
- **Resume**: If interrupted, simply re-run the script - it will skip existing files
